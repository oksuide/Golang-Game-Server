<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Shooter Game</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }

        .upgrade-btn {
            padding: 10px;
            background: #4f5e50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .upgrade-btn:hover {
            background: #45a049;
        }

        .upgrade-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        canvas {
            display: block;
            background-color: #222;
            width: 100vw;
            height: 100vh;
            cursor: crosshair;
            position: relative;
            z-index: 1;
        }

        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: Arial, sans-serif;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 5px;
            z-index: 100;
        }

        #upgrade-menu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            color: white;
            font-family: Arial;
            z-index: 1000;
            pointer-events: none;
        }

        #upgrade-menu .upgrade-btn {
            pointer-events: auto;
        }
    </style>
</head>

<body>
    <div id="status">Connected to server</div>
    <canvas id="gameCanvas"></canvas>
    <div id="upgrade-menu">
        <h2 style="text-align: center; margin-top: 0;">Выберите улучшение</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="upgrade-btn" data-stat="damage">Урон +2</button>
            <button class="upgrade-btn" data-stat="health">Здоровье +15</button>
            <button class="upgrade-btn" data-stat="speed">Скорость +0.5</button>
            <button class="upgrade-btn" data-stat="reload">Перезарядка -0.1s</button>
        </div>
        <div id="skill-points" style="text-align: center; margin-top: 10px;">Очков: 0</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('status');
        const upgradeMenu = document.getElementById('upgrade-menu');

        let skillPoints = 0;
        let upgradeMenuVisible = false;

        // Функция показа/скрытия меню
        function toggleUpgradeMenu(show) {
            upgradeMenu.style.display = show ? 'block' : 'none';
            upgradeMenuVisible = show;

            if (show) {
                document.getElementById('skill-points').textContent = `Очков: ${skillPoints}`;
                // Блокируем кнопки если очков нет
                document.querySelectorAll('.upgrade-btn').forEach(btn => {
                    btn.disabled = skillPoints <= 0;
                });
            }
        }

        // Обработчик клавиши U для открытия меню
        document.addEventListener('keydown', (e) => {
            if (e.key === 'u' && skillPoints > 0) {
                toggleUpgradeMenu(!upgradeMenuVisible);
            }
        });

        // Глобальный обработчик кликов для кнопок улучшений
        document.addEventListener('click', function (e) {
            if (!e.target.classList.contains('upgrade-btn')) return;
            if (skillPoints <= 0) return;

            const btn = e.target;
            const stat = btn.dataset.stat;

            console.log('[Upgrade] Кнопка нажата:', stat);
            console.log('[Upgrade] Отправка на сервер:', { upgradeStat: stat });

            try {
                socket.send(JSON.stringify({
                    type: 'upgrade',
                    stat: stat
                }));

                skillPoints--;
                document.getElementById('skill-points').textContent = `Очков: ${skillPoints}`;
                btn.disabled = skillPoints <= 0;

                if (skillPoints <= 0) {
                    console.log('[Upgrade] Скрытие меню улучшений');
                    toggleUpgradeMenu(false);
                }
            } catch (err) {
                console.error('[Upgrade] Ошибка отправки:', err);
            }
        });

        // Остальной код игры (без изменений)
        let isAuthenticated = false;
        let players = {};
        let bullets = [];
        let myPlayerId = null;
        let mouseX = 0;
        let mouseY = 0;

        // Input state
        let inputState = {
            up: false, down: false, left: false, right: false,
            angle: 0, shoot: false
        };

        // Initialize canvas
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            drawGrid();
        }

        function drawGrid() {
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;

            const gridSize = 50;
            const cols = Math.ceil(canvas.width / gridSize);
            const rows = Math.ceil(canvas.height / gridSize);

            for (let i = 0; i < cols; i++) {
                ctx.beginPath();
                ctx.moveTo(i * gridSize, 0);
                ctx.lineTo(i * gridSize, canvas.height);
                ctx.stroke();
            }

            for (let i = 0; i < rows; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * gridSize);
                ctx.lineTo(canvas.width, i * gridSize);
                ctx.stroke();
            }
        }

        function toCanvasX(x) {
            return x * (canvas.width / 1920);
        }

        function toCanvasY(y) {
            return y * (canvas.height / 1080);
        }

        function drawPlayer(player) {
            const x = toCanvasX(player.X);
            const y = toCanvasY(player.Y);
            const isCurrentPlayer = player.ID === myPlayerId;

            // Player body
            ctx.beginPath();
            ctx.arc(x, y, 12, 0, Math.PI * 2);
            ctx.fillStyle = isCurrentPlayer ? '#00FF00' : '#FF0000';
            ctx.fill();

            // Player border
            ctx.lineWidth = 2;
            ctx.strokeStyle = isCurrentPlayer ? '#FFFFFF' : '#000000';
            ctx.stroke();

            // Direction indicator (gun barrel)
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(
                x + 25 * Math.cos(player.Angle),
                y + 25 * Math.sin(player.Angle)
            );
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#FFFFFF';
            ctx.stroke();

            // Player ID
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(player.ID, x, y);
        }

        function drawBullet(bullet) {
            ctx.beginPath();
            ctx.arc(
                toCanvasX(bullet.X),
                toCanvasY(bullet.Y),
                5, 0, Math.PI * 2
            );
            ctx.fillStyle = '#FFFF00';
            ctx.fill();

            // Bullet trail
            ctx.beginPath();
            ctx.moveTo(
                toCanvasX(bullet.X - 10 * Math.cos(bullet.Angle)),
                toCanvasY(bullet.Y - 10 * Math.sin(bullet.Angle))
            );
            ctx.lineTo(toCanvasX(bullet.X), toCanvasY(bullet.Y));
            ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function updatePlayerStats(stats) {
            // Обновляем UI с новыми характеристиками
            console.log('Обновлены характеристики:', stats);
        }

        function updateScene() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawGrid();
            Object.values(players).forEach(drawPlayer);
            bullets.forEach(drawBullet);

            // Debug info
            if (myPlayerId && players[myPlayerId]) {
                const player = players[myPlayerId];
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`Position: (${Math.round(player.X)}, ${Math.round(player.Y)})`, 10, 20);
                ctx.fillText(`Angle: ${Math.round(player.Angle * 180 / Math.PI)}°`, 10, 40);
            }
            if (!isAuthenticated) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(canvas.width / 2 - 150, canvas.height / 2 - 25, 300, 50);
                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Connecting to server...', canvas.width / 2, canvas.height / 2);
            }
        }

        // Calculate angle between player and mouse
        function calculateAngle(playerX, playerY, mouseX, mouseY) {
            return Math.atan2(mouseY - playerY, mouseX - playerX);
        }

        // WebSocket connection
        const socket = new WebSocket('ws://localhost:8080/ws');

        socket.onmessage = function (event) {
            try {
                const data = JSON.parse(event.data);

                // Обновление очков навыков
                if (data.skill_points !== undefined) {
                    skillPoints = data.skill_points;
                    document.getElementById('skill-points').textContent = `Очков: ${skillPoints}`;
                }

                // Обновление характеристик игрока
                if (data.stats) {
                    updatePlayerStats(data.stats);
                }

                // Обработка смерти игрока
                if (data.playerDied) {
                    const playerId = data.playerDied;
                    if (players[playerId]) {
                        players[playerId].alive = false;
                        console.log(`Player ${playerId} died`);
                    }
                }

                // Обработка респавна
                if (data.playerRespawned) {
                    const playerId = data.playerRespawned;
                    if (players[playerId]) {
                        players[playerId].alive = true;
                        console.log(`Player ${playerId} respawned`);
                    }
                }

                // Основная логика
                if (data.yourId && !myPlayerId) {
                    myPlayerId = data.yourId;
                    isAuthenticated = true;
                    statusDiv.textContent = `Connected as Player ${myPlayerId}`;
                    console.log("Authenticated with ID:", myPlayerId);
                }

                if (data.players) players = data.players;
                if (data.bullets) bullets = data.bullets;

                updateScene();

            } catch (e) {
                console.error('Error parsing message:', e);
            }
        };


        socket.onclose = function () {
            statusDiv.textContent = "Disconnected. Refresh page to reconnect.";
        };

        // Send input to server
        function sendInput() {
            // console.log("Sending:", JSON.stringify({
            //     ...inputState,
            //     angle: inputState.angle  // Убедитесь, что angle включен
            // }));

            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(inputState));
            }
        }


        // Обработчик движения мыши
        canvas.addEventListener('mousemove', (e) => {
            if (!isAuthenticated || !myPlayerId || !players[myPlayerId]) {
                console.warn("Not authenticated or player not initialized");
                return;
            }

            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const gameMouseX = mouseX * (1920 / canvas.width);
            const gameMouseY = mouseY * (1080 / canvas.height);

            const player = players[myPlayerId];
            const dx = gameMouseX - player.X;
            const dy = gameMouseY - player.Y;
            inputState.angle = Math.atan2(dy, dx);

            // console.log(`Sending angle: ${inputState.angle.toFixed(2)}`);
            sendInput();
        });

        // Обработчик клика для стрельбы
        canvas.addEventListener('click', (e) => {
            inputState.shoot = true;
            sendInput();
            setTimeout(() => { inputState.shoot = false; sendInput(); }, 100);
        });

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (e.key === 'w' || e.key === 'ArrowUp') inputState.up = true;
            if (e.key === 's' || e.key === 'ArrowDown') inputState.down = true;
            if (e.key === 'a' || e.key === 'ArrowLeft') inputState.left = true;
            if (e.key === 'd' || e.key === 'ArrowRight') inputState.right = true;
            sendInput();
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'w' || e.key === 'ArrowUp') inputState.up = false;
            if (e.key === 's' || e.key === 'ArrowDown') inputState.down = false;
            if (e.key === 'a' || e.key === 'ArrowLeft') inputState.left = false;
            if (e.key === 'd' || e.key === 'ArrowRight') inputState.right = false;
            sendInput();
        });

        // Shooting controls
        canvas.addEventListener('mousedown', (e) => {
            if (e.button === 0) { // Left mouse button
                inputState.shoot = true;
                sendInput();
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (e.button === 0) {
                inputState.shoot = false;
                sendInput();
            }
        });

        // Initial setup
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
    </script>
    <div id="upgrade-menu" style="display: none;
           position: fixed;
           top: 50%;
           left: 50%;
           transform: translate(-50%, -50%);
           background: rgba(0,0,0,0.8);
           padding: 20px;
           border-radius: 10px;
           color: white;
           font-family: Arial;
           z-index: 1000;
           pointer-events: none;"> <!-- Добавлено здесь -->
        <h2 style="text-align: center; margin-top: 0;">Выберите улучшение</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="upgrade-btn" style="pointer-events: auto" data-stat="damage">Урон +2</button>
            <button class="upgrade-btn" style="pointer-events: auto" data-stat="health">Здоровье +15</button>
            <button class="upgrade-btn" style="pointer-events: auto" data-stat="speed">Скорость +0.5</button>
            <button class="upgrade-btn" style="pointer-events: auto" data-stat="reload">Перезарядка -0.1s</button>
        </div>
        <div id="skill-points" style="text-align: center; margin-top: 10px;">Очков: 0</div>
    </div>
</body>

</html>